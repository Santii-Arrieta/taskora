<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Migraci√≥n de Base de Datos - Taskora</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #6c757d; cursor: not-allowed; }
        .log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ Migraci√≥n de Base de Datos - Taskora</h1>
        <p>Esta herramienta ejecutar√° autom√°ticamente la migraci√≥n de la base de datos para optimizar el sistema de chat.</p>
        
        <div id="status" class="status info">
            ‚è≥ Listo para ejecutar la migraci√≥n
        </div>
        
        <button onclick="executeMigration()" id="migrateBtn">
            üîß Ejecutar Migraci√≥n
        </button>
        
        <button onclick="verifyMigration()" id="verifyBtn">
            ‚úÖ Verificar Migraci√≥n
        </button>
        
        <div id="log" class="log" style="display: none;"></div>
    </div>

    <script>
        // Configuraci√≥n de Supabase
        const supabaseUrl = 'https://lmxcmpksctnqsqwhfkvy.supabase.co';
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxteGNtcGtzY3RucXNxd2hma3Z5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUwMDgzNTIsImV4cCI6MjA3MDU4NDM1Mn0.YEiZ1RogTH8n9uwytnRo2ueimJlz_HkSi_COTLyGtKQ';
        
        const supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey);
        
        function log(message) {
            const logDiv = document.getElementById('log');
            logDiv.style.display = 'block';
            logDiv.textContent += new Date().toLocaleTimeString() + ': ' + message + '\n';
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }
        
        async function executeMigration() {
            const migrateBtn = document.getElementById('migrateBtn');
            const verifyBtn = document.getElementById('verifyBtn');
            
            migrateBtn.disabled = true;
            updateStatus('üöÄ Ejecutando migraci√≥n...', 'info');
            
            try {
                log('Iniciando migraci√≥n de base de datos...');
                
                // Paso 1: Crear tabla messages
                log('Creando tabla messages...');
                const { error: createError } = await supabase.rpc('exec', {
                    sql: `
                        CREATE TABLE IF NOT EXISTS messages (
                            id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
                            conversation_id TEXT NOT NULL,
                            sender_id UUID NOT NULL,
                            content JSONB NOT NULL,
                            type TEXT DEFAULT 'text',
                            read BOOLEAN DEFAULT FALSE,
                            created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
                            updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
                        );
                    `
                });
                
                if (createError) {
                    throw new Error('Error creando tabla: ' + createError.message);
                }
                log('‚úÖ Tabla messages creada');
                
                // Paso 2: Crear √≠ndices
                log('Creando √≠ndices...');
                const indexes = [
                    'CREATE INDEX IF NOT EXISTS idx_messages_conversation_id ON messages(conversation_id);',
                    'CREATE INDEX IF NOT EXISTS idx_messages_sender_id ON messages(sender_id);',
                    'CREATE INDEX IF NOT EXISTS idx_messages_created_at ON messages(created_at DESC);',
                    'CREATE INDEX IF NOT EXISTS idx_messages_read_status ON messages(read) WHERE read = FALSE;'
                ];
                
                for (const indexSQL of indexes) {
                    const { error: indexError } = await supabase.rpc('exec', { sql: indexSQL });
                    if (indexError) {
                        log('‚ö†Ô∏è Error creando √≠ndice: ' + indexError.message);
                    }
                }
                log('‚úÖ √çndices creados');
                
                // Paso 3: Agregar campos a conversations
                log('Agregando campos a conversations...');
                const { error: alterError } = await supabase.rpc('exec', {
                    sql: `
                        ALTER TABLE conversations 
                        ADD COLUMN IF NOT EXISTS message_count INTEGER DEFAULT 0,
                        ADD COLUMN IF NOT EXISTS last_read_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
                        ADD COLUMN IF NOT EXISTS updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW();
                    `
                });
                
                if (alterError) {
                    log('‚ö†Ô∏è Error agregando campos: ' + alterError.message);
                } else {
                    log('‚úÖ Campos agregados a conversations');
                }
                
                // Paso 4: Crear funci√≥n mark_messages_as_read
                log('Creando funci√≥n mark_messages_as_read...');
                const { error: functionError } = await supabase.rpc('exec', {
                    sql: `
                        CREATE OR REPLACE FUNCTION mark_messages_as_read(
                            p_conversation_id TEXT,
                            p_user_id UUID
                        )
                        RETURNS INTEGER AS $$
                        DECLARE
                            updated_count INTEGER;
                        BEGIN
                            UPDATE messages 
                            SET read = TRUE, updated_at = NOW()
                            WHERE conversation_id = p_conversation_id 
                            AND sender_id != p_user_id 
                            AND read = FALSE;
                            
                            GET DIAGNOSTICS updated_count = ROW_COUNT;
                            
                            UPDATE conversations 
                            SET last_read_at = NOW(), updated_at = NOW()
                            WHERE id = p_conversation_id;
                            
                            RETURN updated_count;
                        END;
                        $$ LANGUAGE plpgsql;
                    `
                });
                
                if (functionError) {
                    log('‚ö†Ô∏è Error creando funci√≥n: ' + functionError.message);
                } else {
                    log('‚úÖ Funci√≥n mark_messages_as_read creada');
                }
                
                // Paso 5: Habilitar RLS
                log('Habilitando Row Level Security...');
                const { error: rlsError } = await supabase.rpc('exec', {
                    sql: 'ALTER TABLE messages ENABLE ROW LEVEL SECURITY;'
                });
                
                if (rlsError) {
                    log('‚ö†Ô∏è Error habilitando RLS: ' + rlsError.message);
                } else {
                    log('‚úÖ Row Level Security habilitado');
                }
                
                // Paso 6: Crear pol√≠ticas
                log('Creando pol√≠ticas de seguridad...');
                const policies = [
                    `CREATE POLICY "Users can view messages from their conversations" ON messages
                     FOR SELECT USING (
                         conversation_id IN (
                             SELECT id FROM conversations 
                             WHERE participants @> jsonb_build_array(jsonb_build_object('id', auth.uid()))
                         )
                     );`,
                    `CREATE POLICY "Users can insert messages in their conversations" ON messages
                     FOR INSERT WITH CHECK (
                         conversation_id IN (
                             SELECT id FROM conversations 
                             WHERE participants @> jsonb_build_array(jsonb_build_object('id', auth.uid()))
                         )
                     );`,
                    `CREATE POLICY "Users can update their own messages" ON messages
                     FOR UPDATE USING (sender_id = auth.uid());`
                ];
                
                for (const policySQL of policies) {
                    const { error: policyError } = await supabase.rpc('exec', { sql: policySQL });
                    if (policyError) {
                        log('‚ö†Ô∏è Error creando pol√≠tica: ' + policyError.message);
                    }
                }
                log('‚úÖ Pol√≠ticas de seguridad creadas');
                
                updateStatus('‚úÖ Migraci√≥n completada exitosamente!', 'success');
                verifyBtn.disabled = false;
                log('üéâ ¬°Migraci√≥n completada! Ahora puedes verificar los resultados.');
                
            } catch (error) {
                updateStatus('‚ùå Error en la migraci√≥n: ' + error.message, 'error');
                log('‚ùå Error: ' + error.message);
                migrateBtn.disabled = false;
            }
        }
        
        async function verifyMigration() {
            const verifyBtn = document.getElementById('verifyBtn');
            verifyBtn.disabled = true;
            updateStatus('üîç Verificando migraci√≥n...', 'info');
            
            try {
                log('Verificando migraci√≥n...');
                
                // Verificar tabla messages
                const { data: messages, error: messagesError } = await supabase
                    .from('messages')
                    .select('*')
                    .limit(1);
                
                if (messagesError) {
                    throw new Error('Tabla messages no encontrada: ' + messagesError.message);
                }
                log('‚úÖ Tabla messages verificada');
                
                // Verificar campos en conversations
                const { data: conversations, error: convError } = await supabase
                    .from('conversations')
                    .select('message_count, last_read_at, updated_at')
                    .limit(1);
                
                if (convError) {
                    log('‚ö†Ô∏è Campos nuevos en conversations no encontrados: ' + convError.message);
                } else {
                    log('‚úÖ Campos nuevos en conversations verificados');
                }
                
                // Verificar funci√≥n
                const { data: functionData, error: funcError } = await supabase.rpc('mark_messages_as_read', {
                    p_conversation_id: 'test',
                    p_user_id: '00000000-0000-0000-0000-000000000000'
                });
                
                if (funcError && !funcError.message.includes('test')) {
                    log('‚ö†Ô∏è Funci√≥n mark_messages_as_read no encontrada: ' + funcError.message);
                } else {
                    log('‚úÖ Funci√≥n mark_messages_as_read verificada');
                }
                
                updateStatus('‚úÖ Verificaci√≥n completada - Migraci√≥n exitosa!', 'success');
                log('üéâ ¬°Todo est√° funcionando correctamente!');
                
            } catch (error) {
                updateStatus('‚ùå Error en verificaci√≥n: ' + error.message, 'error');
                log('‚ùå Error: ' + error.message);
            } finally {
                verifyBtn.disabled = false;
            }
        }
    </script>
</body>
</html>

